<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>ZoomByDomain</title>
<script type="text/javascript">

var zoomStep = safari.extension.settings.zoomStep;
var defaultZoom = safari.extension.settings.defaultZoom;
var zoomDB;
var DB_MAX_SIZE = 1 * 1024 * 1024;

function performCommand(event) {
    var zoomFactor = 0;
    if (event.command === "zoomIn") {
        zoomFactor = zoomStep;
    } else if (event.command === "zoomOut") {
        zoomFactor = zoomStep * -1;
    } else if (event.command === "zoomDebug") {
        showTableContents();
        return;
    } else if (event.command === "zoomClearDatabase") {
        clearDatabase();
        return;
    }

   safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("zoomBy", zoomFactor);
}

function clearDatabase() {
    zoomDB.transaction(
        function (transaction) {
            transaction.executeSql('DELETE from sites;', [], nullDataHandler, errorHandler);
        }
    );
}

function showTableContents() {
    zoomDB.transaction(
        function (transaction) {
            transaction.executeSql('SELECT * from sites;', [], sitesDataHandler, errorHandler);
        }
    );
}

function sitesDataHandler(transaction, results) {
    var contents = "Contents of sites table:\n";
    for (var i = 0; i < results.rows.length; i++) {
        var row = results.rows.item(i);
        contents += row['domain'] + ", " + row['zoom'] + ", " + row['id'] + '\n';
    }
    window.console.info(contents);
}

function getZoomForDomain(domain) {
    zoomDB.transaction(
        function (transaction) {
            transaction.executeSql('SELECT * FROM sites WHERE domain=?', [domain],
                        function(transaction, results) { zoomDataHandler(transaction, results, domain); }, errorHandler);
        }
    );
}

function zoomDataHandler(transaction, results, domain) {
    var newZoom = defaultZoom;
    if (results.rows.length != 0) {
        newZoom = results.rows.item(0)['zoom'];
    } else if (defaultZoom == 100) {
        return;
    }
    updateAllTabsWithDomain(domain, newZoom);
}

function updateAllTabsWithDomain(domain, zoom) {
    var windows = safari.application.browserWindows;
    for (var i = 0; i < windows.length; i++) {
        var tabs = windows[i].tabs;
        for (var j = 0; j < tabs.length; j++) { 
            if (!tabs[j].url) { continue; }
            var temp = tabs[j].url.match(/:\/\/([a-zA-Z0-9.\-]+)\//);
            if (temp && temp.length > 1) {
                var tabDomain = temp[1];
                if (tabDomain === domain) {
                    tabs[j].page.dispatchMessage("initZoom", zoom);
                }
            }
        }
    }
}

function saveZoom(domain, zoom) {
    if (domain === "") {
        return;
    }

    zoomDB.transaction(
        function (transaction) {
            transaction.executeSql('INSERT INTO sites (domain, zoom) VALUES (?, ?);',
                                   [domain, zoom], nullDataHandler, function (transaction, error) {
                    transaction.executeSql('UPDATE sites SET zoom=? WHERE domain=?;',
                                           [zoom, domain], nullDataHandler, errorHandler);
                }
            );
        }
    );
    updateAllTabsWithDomain(domain, zoom);
}

function validateCommand(event) {
    if (event.command === "zoomIn" || event.command === "zoomOut") {
        event.target.disabled = false;
    }
}

function handleMessage(message) {
    console.log("handleMessage, message = " + message.name);
    if (message.name === "initZoom") {
        initZoom(message.message);
    } else if (message.name === "saveZoom") {
        saveZoom(message.message[0], message.message[1]);
    } else if (message.name === "zoomIn") {
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("zoomBy", zoomStep);
    } else if (message.name === "zoomOut") {
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("zoomBy", zoomStep * -1);
    } else if (message.name === "zoomDefault") {
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("zoomTo", defaultZoom);
    }
}

function initZoom(domain) {
    getZoomForDomain(domain);
}

function settingsChanged(event) {
    var arguments;
    if (event.key === "zoomStep") {
        zoomStep = event.newValue;
        return true;
    } else if (event.key === "defaultZoom") {
        defaultZoom = event.newValue;
        return true;
    }
}

function init() {
    safari.application.addEventListener("command", performCommand, false);
    safari.application.addEventListener("validate", validateCommand, false);
    safari.application.addEventListener("message", handleMessage, false);
    safari.extension.settings.addEventListener("change", settingsChanged, false);

    initDatabase();
}

function nullDataHandler(transaction, results) { }

function errorHandler(transaction, error) {
    if (error.code === 5) {
        return;
    } else if (error.code === 1) {
        return;
    }
    alert("Error in database: (" + error.code + ") - " + error.message);
    return true;
}

function initDatabase() {
    if (!window.openDatabase) {
        window.console.error("Local Storage Database not supported");
        return;
    }

    try {
        zoomDB = openDatabase("MyZoomDB", "1.0", "ZoomByDomain Database", DB_MAX_SIZE);
    } catch (e) {
        if (e === 2) {
            window.console.error("Invalid database version");
        } else {
            window.console.error("Unknown error opening database: " + e);
        }
    }

    zoomDB.transaction(
        function (transaction) {
            transaction.executeSql('CREATE TABLE sites(id INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, domain TEXT NOT NULL UNIQUE, zoom INTEGER NOT NULL);', [], nullDataHandler, errorHandler);
        }
    );
}


init();

</script>
</head>
<body>
</body>
</html>
